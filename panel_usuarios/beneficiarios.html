<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel - Beneficiarios</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="img/LOGO_CS.jpg" type="image/jpeg" sizes="32x32">
  <style>
    @media (max-width:767px){
      aside{position:fixed;left:0;top:0;height:100%;transform:translateX(-110%);transition:transform .2s ease;background:#0ea5a2;z-index:40}
      body.mobile-open aside{transform:translateX(0)}
      #mobile-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:30}
      body.mobile-open #mobile-overlay{display:block}
      main{padding:1rem}
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="bg-sky-700 text-white w-64 p-6 space-y-6" id="sidebar">
    <h2 class="text-2xl font-bold">MiSeguro</h2>
    <nav class="space-y-4">
      <a href="Index.html" class="block hover:bg-indigo-500 p-2 rounded">üè† Inicio</a>
      <a href="poliza.html" class="block hover:bg-indigo-500 p-2 rounded">üìÑ Mi P√≥liza</a>
      <a href="pagos.html" class="block hover:bg-indigo-500 p-2 rounded">üí≥ Pagos</a>
      <a href="beneficiarios.html" class="block bg-indigo-500 p-2 rounded font-semibold">üë®‚Äçüë©‚Äçüëß Beneficiarios</a>
      <a href="documentos.html" class="block hover:bg-indigo-500 p-2 rounded">üì• Documentos</a>
      <a href="soporte.html" class="block hover:bg-indigo-500 p-2 rounded">‚ùì Soporte</a>
    </nav>
  </aside>

  <main class="flex-1 p-6 md:p-8">
    <div class="max-w-6xl mx-auto space-y-6">
      <div class="bg-white shadow rounded-2xl p-6 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Beneficiarios</h1>
          <p class="text-sm text-gray-500">Gestiona los beneficiarios de tu p√≥liza</p>
        </div>
        <div>
          <button id="btn-add-beneficiary" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Agregar beneficiario</button>
        </div>
      </div>

      <section class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Lista de beneficiarios</h3>
          <div class="text-sm text-gray-600">Total asignado: <span id="total-percent">0</span>%</div>
        </div>

        <div class="w-full bg-gray-100 rounded h-2 mb-4 overflow-hidden">
          <div id="percent-bar" class="h-2 bg-green-500" style="width:0%"></div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="benef-table">
            <thead class="text-left text-gray-600 border-b">
              <tr>
                <th class="p-2">Nombre completo</th>
                <th class="p-2">Parentesco</th>
                <th class="p-2">% Asignado</th>
                <th class="p-2">Principal</th>
                <th class="p-2">Acciones</th>
              </tr>
            </thead>
            <tbody id="lista"></tbody>
          </table>
        </div>

        <p id="empty-msg" class="text-sm text-gray-500 mt-4 hidden">No hay beneficiarios. A√±ade uno para comenzar.</p>
      </section>

      <section class="bg-white rounded-2xl shadow p-6">
        <h3 class="text-lg font-semibold mb-2">Buenas pr√°cticas</h3>
        <ul class="list-disc pl-6 text-sm text-gray-600">
          <li>Distribuye el porcentaje total entre tus beneficiarios (m√°x. 100%).</li>
          <li>Marca un beneficiario como <strong>principal</strong> si deseas que reciba un contacto preferente.</li>
          <li>Guarda cambios y verifica que el total no supere el 100%.</li>
        </ul>
      </section>
    </div>
  </main>

  <!-- Modal para agregar/editar beneficiario (accesible) -->
  <div id="benef-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="benef-title">
    <div class="absolute inset-0 bg-black opacity-40" data-close="overlay"></div>
    <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md p-6 z-10">
      <h3 id="benef-title" class="text-lg font-semibold mb-3">Agregar beneficiario</h3>
      <form id="benef-form" class="space-y-3" novalidate>
        <input type="hidden" name="_idx" />
        <div>
          <label class="block text-sm">Nombre <span class="text-red-600">*</span></label>
          <input required name="nombre" class="w-full p-2 border rounded" aria-required="true" />
          <div class="text-xs text-red-600 hidden" id="error-nombre">Nombre requerido</div>
        </div>
        <div>
          <label class="block text-sm">Parentesco</label>
          <input name="parentesco" class="w-full p-2 border rounded" />
        </div>
        <div>
          <label class="block text-sm">Porcentaje</label>
          <div class="flex gap-2">
            <input name="porcentaje" type="number" min="0" max="100" step="1" class="w-32 p-2 border rounded" />
            <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" name="principal" /> Marcar como principal</label>
          </div>
          <div class="text-xs text-red-600 hidden" id="error-porcentaje">Porcentaje inv√°lido o suma > 100%</div>
        </div>
        <div class="flex justify-between items-center">
          <div class="text-xs text-gray-500">Los cambios se guardan localmente. Opcionalmente puedes sincronizar con el servidor.</div>
          <div class="flex gap-2">
            <button type="button" id="benef-cancel" class="px-4 py-2 rounded bg-gray-200">Cancelar</button>
            <button type="submit" id="benef-save" class="px-4 py-2 rounded bg-blue-600 text-white">Guardar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="mobile-overlay"></div>

  <!-- Toast -->
  <div id="toast" class="fixed right-4 bottom-6 z-50 hidden max-w-sm"></div>

  <script>
    (function(){
      const STORAGE_KEY = 'beneficiarios_v2';
      const listEl = document.getElementById('lista');
      const openBtn = document.getElementById('btn-add-beneficiary');
      const modal = document.getElementById('benef-modal');
      const form = document.getElementById('benef-form');
      const cancelBtn = document.getElementById('benef-cancel');
      const emptyMsg = document.getElementById('empty-msg');
      const totalPercentEl = document.getElementById('total-percent');
      const percentBar = document.getElementById('percent-bar');
      const toastEl = document.getElementById('toast');

      function toast(msg, type='info'){
        toastEl.innerHTML = `<div class=\"rounded shadow px-4 py-2 bg-white border ${type==='error'? 'border-red-300': 'border-gray-200'}\">${msg}</div>`;
        toastEl.classList.remove('hidden');
        setTimeout(()=> toastEl.classList.add('hidden'), 3000);
      }

      function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ return []; } }
      function save(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); render(arr); }

      function computeTotal(arr){ return arr.reduce((s,i)=> s + (Number(i.porcentaje)||0), 0); }

      function render(arr){
        listEl.innerHTML = '';
        if(!arr.length){ emptyMsg.classList.remove('hidden'); return; } else emptyMsg.classList.add('hidden');
        arr.forEach((b, idx)=>{
          const tr = document.createElement('tr');
          tr.className = 'border-b';
          tr.innerHTML = `
            <td class=\"p-2\">${escapeHtml(b.nombre)}</td>
            <td class=\"p-2\">${escapeHtml(b.parentesco||'')}</td>
            <td class=\"p-2\">${escapeHtml(b.porcentaje||'0')}%</td>
            <td class=\"p-2\">${b.principal? '<strong>S√≠</strong>':'No'}</td>
            <td class=\"p-2\">\n              <button class=\"edit-btn text-blue-600 mr-2\" data-idx=\"${idx}\">Editar</button>\n              <button class=\"del-btn text-red-600\" data-idx=\"${idx}\">Eliminar</button>\n            </td>`;
          listEl.appendChild(tr);
        });
        const total = computeTotal(arr);
        totalPercentEl.textContent = total;
        percentBar.style.width = Math.min(100, total) + '%';
        percentBar.classList.toggle('bg-red-500', total>100);
        percentBar.classList.toggle('bg-green-500', total<=100);
      }

      function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }

      function openModalForEdit(idx, arr){
        const item = arr[idx];
        form._idx.value = idx;
        form.nombre.value = item.nombre || '';
        form.parentesco.value = item.parentesco || '';
        form.porcentaje.value = item.porcentaje || '';
        form.principal.checked = !!item.principal;
        modal.classList.remove('hidden'); modal.classList.add('flex');
      }

      function openModalEmpty(){ form._idx.value = ''; form.reset(); modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(()=> form.nombre.focus(),50); }
      function closeModal(){ modal.classList.remove('flex'); modal.classList.add('hidden'); form.reset(); document.getElementById('error-nombre').classList.add('hidden'); document.getElementById('error-porcentaje').classList.add('hidden'); }

      openBtn.addEventListener('click', openModalEmpty);
      cancelBtn.addEventListener('click', closeModal);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const idx = fd.get('_idx');
        const nombre = (fd.get('nombre')||'').trim();
        const parentesco = (fd.get('parentesco')||'').trim();
        const porcentaje = Number(fd.get('porcentaje')||0);
        const principal = fd.get('principal') ? true : false;

        let valid = true;
        if(!nombre){ document.getElementById('error-nombre').classList.remove('hidden'); valid=false; }
        else document.getElementById('error-nombre').classList.add('hidden');
        if(isNaN(porcentaje) || porcentaje<0){ document.getElementById('error-porcentaje').classList.remove('hidden'); valid=false; }

        const arr = load();
        // compute total if saved
        const tempArr = arr.slice();
        if(idx !== ''){ // editing: replace
          tempArr[Number(idx)] = { nombre, parentesco, porcentaje, principal };
        } else { tempArr.push({ nombre, parentesco, porcentaje, principal }); }
        const total = computeTotal(tempArr);
        if(total>100){ document.getElementById('error-porcentaje').textContent = 'La suma total excede 100%'; document.getElementById('error-porcentaje').classList.remove('hidden'); valid=false; }
        else { document.getElementById('error-porcentaje').classList.add('hidden'); }

        if(!valid) return;

        // if principal set, unset others
        if(principal){ tempArr.forEach(it=> it.principal = false); }

        if(idx !== ''){
          arr[Number(idx)] = { nombre, parentesco, porcentaje, principal };
        } else {
          arr.push({ nombre, parentesco, porcentaje, principal });
        }

        // save locally and render
        save(arr);
        closeModal();
        toast('Beneficiario guardado');

        // optional: try to sync with server (non-blocking)
        try{
          // await fetch('/api/beneficiarios', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(arr) });
        }catch(err){ console.warn('Sync failed', err); }
      });

      // edit / delete handlers
      document.getElementById('lista').addEventListener('click', (e)=>{
        const t = e.target;
        if(t.matches('.del-btn')){
          const idx = Number(t.dataset.idx);
          if(!confirm('¬øEliminar beneficiario?')) return;
          const arr = load(); arr.splice(idx,1); save(arr); toast('Beneficiario eliminado');
        } else if(t.matches('.edit-btn')){
          const idx = Number(t.dataset.idx);
          const arr = load(); openModalForEdit(idx, arr);
        }
      });

      // initialize
      render(load());

      // swipe/overlay sidebar code preserved for mobile
      (function(){
        const overlay=document.getElementById('mobile-overlay');
        if(overlay) overlay.addEventListener('click',()=>{ document.body.classList.remove('mobile-open'); document.body.style.overflow=''; });
        let startX=0, startY=0, active=false; const EDGE_ZONE=30, OPEN_THRESHOLD=60, CLOSE_THRESHOLD=-60;
        function onStart(e){ const t=(e.touches&&e.touches[0])||e; startX=t.clientX; startY=t.clientY; active=(startX<=EDGE_ZONE)||document.body.classList.contains('mobile-open'); }
        function onMove(e){ if(!active) return; const t=(e.touches&&e.touches[0])||e; const dx=t.clientX-startX, dy=t.clientY-startY; if(Math.abs(dy)>50){ active=false; return; } }
        function onEnd(e){ if(!active) return; const t=(e.changedTouches&&e.changedTouches[0])||e; const dx=t.clientX-startX; if(!document.body.classList.contains('mobile-open') && dx>OPEN_THRESHOLD){ document.body.classList.add('mobile-open'); document.body.style.overflow='hidden'; } else if(document.body.classList.contains('mobile-open') && dx<CLOSE_THRESHOLD){ document.body.classList.remove('mobile-open'); document.body.style.overflow=''; } active=false; }
        document.addEventListener('touchstart', onStart, {passive:true}); document.addEventListener('touchmove', onMove, {passive:true}); document.addEventListener('touchend', onEnd, {passive:true});
        let mdown=false; document.addEventListener('mousedown',(e)=>{ startX=e.clientX; startY=e.clientY; mdown=(startX<=EDGE_ZONE)||document.body.classList.contains('mobile-open'); });
        document.addEventListener('mousemove',(e)=>{ if(!mdown) return; const dx=e.clientX-startX; if(document.body.classList.contains('mobile-open')) return; if(dx>OPEN_THRESHOLD){ document.body.classList.add('mobile-open'); document.body.style.overflow='hidden'; mdown=false; } });
        document.addEventListener('mouseup',()=>{ mdown=false; });
      })();

      // helper to save and render
      function save(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); render(arr); }

    })();
  </script>

  <script>
    // Incluir el archivo poliza.js
    </script>
    <script src="Js/poliza.js"></script>
  </script>
</body>
</html>